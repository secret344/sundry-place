# 拥塞控制算法

当网络出现拥堵时候，如果继续发送大量数据包，会导致数据包时延、丢包等，这时 tcp 就会重传数据，但是一但重传就会导致网络更大的负担，导致更大范围的时延和丢包，这个情况就会无限放大。

所以 TCP 被设计成一个无私的协议，当网络发生拥塞时，TCP 会降低发送的数据量。为此产生了拥塞控制，目的是为避免发送方数据填满整个网络。发送方调节所要发送数据的量，定义了拥塞窗口（cwnd）的概念。

新建连接时，cwnd 初始化为连接所能承受的 MSS 的最小倍数，之前我们知道发送方窗口(swnd)大小约等于接收窗口（rwnd），当加入拥塞窗口概念后，发送方窗口 swnd = min(rwnd,cwnd),也就是拥塞窗口和接收窗口的最小值。当网络没有出现拥塞时就会 cwnd 增大，出现时就会减少。

判断网络出现拥塞：发送发没有在规定时间收到 ACK，也就是超时重传。

## 慢开始

TCP 建立连接之后，就会发生慢启动，慢启动初始启动时设置拥塞窗口值（swnd）为 1，同时会设置慢启动阈值（ssthresh），当 swnd 小于 ssthresh 的时候使用慢启动算法，在 swnd 大于 ssthresh 的时候使用拥塞避免算法。

在慢启动期间，在收到 ACK 时，TCP 最多将 cwnd 增加 MSS 字节，在每个 RTT 内成倍增加，不完全时指数增长，因为接收方延迟确认，没两个分段发送一次 ACK。发送速率随着慢启动时间的增长而增加，知道出现丢失或者到达 ssthresh，当出现丢包 TCP 会采取措施降低网络负载，当达到阈值会进行拥塞避免算法。对于处理报文丢失这个事件上，不同拥塞控制算法表现有所不同：

-   TCP Tahoe

    对于 TCP Tahoe 算法，当发生丢失时，会进入“快速重传”机制，慢启动阈值设为之前拥塞窗口值的一半，拥塞窗口值降为初始值，重新进入慢启动阶段。当拥塞窗口值达到慢启动阈值时，每 RTT 内拥塞窗口增加值则为“MSS 除以 cwnd”的值，所以拥塞窗口按线性速度增加。

-   TCP Reno

    TCP Reno 算法实现了一个名为“快速恢复”的机制，慢启动阈值设为之前拥塞窗口值的一半，和作为新的拥塞窗口值，并跳过慢启动阶段，直接进入拥塞控制阶段。

## 拥塞避免

[cwnd += SMSS\*SMSS/cwnd](https://datatracker.ietf.org/doc/html/rfc5681#section-3.1)
拥塞避免期间，每个 RTT 期间 cwnd 大约增加 1 的分段量，

## 快速恢复

ssthresh = cwnd / 2；cwnd = ssthresh；

进入快速恢复后：

-   因为收到 3 个 ACK 所以，cwnd = ssthresh + 3
-   重传丢失的数据包
-   收到 DACK，cend 继续增加 1
-   收到 ACK，cwnd = ssthresh，结束快速恢复，重新进入拥塞避免。
